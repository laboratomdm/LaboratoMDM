<Window x:Class="LaboratoMDM.UI.Operator.Views.AgentWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:LaboratoMDM.UI.Operator.Views"
        xmlns:ribbon="clr-namespace:System.Windows.Controls.Ribbon;assembly=System.Windows.Controls.Ribbon"
        mc:Ignorable="d"
        Title="AgentWindow" Height="600" Width="1000"
        FontFamily="Segoe UI" FontSize="12">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <ribbon:Ribbon Grid.Row="0">

            <!--  DASHBOARD  -->
            <ribbon:RibbonTab Header="Дэшборд">
                <ribbon:RibbonGroup Header="Обзор">
                    <ribbon:RibbonButton Label="Общий статус"
                                  Command="{Binding OpenDashboardOverviewCommand}"/>
                    <ribbon:RibbonButton Label="Последние события"
                                  Command="{Binding OpenEventsCommand}"/>
                </ribbon:RibbonGroup>

                <ribbon:RibbonGroup Header="Метрики">
                    <ribbon:RibbonButton Label="Активные агенты"
                                  Command="{Binding ShowActiveAgentsCommand}"/>
                    <ribbon:RibbonButton Label="Ошибки политик"
                                  Command="{Binding ShowPolicyErrorsCommand}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

            <!--  NETWORK -->
            <ribbon:RibbonTab Header="Сеть">
                <ribbon:RibbonGroup Header="Агенты">
                    <ribbon:RibbonButton Label="Все агенты"
                                  Command="{Binding ShowAllAgentsCommand}"/>
                    <ribbon:RibbonButton Label="Онлайн"
                                  Command="{Binding ShowOnlineAgentsCommand}"/>
                    <ribbon:RibbonButton Label="Оффлайн"
                                  Command="{Binding ShowOfflineAgentsCommand}"/>
                </ribbon:RibbonGroup>

                <ribbon:RibbonGroup Header="Управление">
                    <ribbon:RibbonButton Label="Обновить статус"
                                  Command="{Binding RefreshAgentStatusCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                    <ribbon:RibbonButton Label="Перезагрузить"
                                  Command="{Binding RebootAgentCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                    <ribbon:RibbonButton Label="Выключить"
                                  Command="{Binding ShutdownAgentCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                    <ribbon:RibbonButton Label="Удалить"
                                  Command="{Binding RemoveAgentCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                </ribbon:RibbonGroup>

                <ribbon:RibbonGroup Header="Сеть">
                    <ribbon:RibbonButton Label="IP конфигурация"
                                  Command="{Binding ShowIpConfigCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                    <ribbon:RibbonButton Label="Ping"
                                  Command="{Binding PingAgentCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

            <!-- POLICY LIBRARY  -->
            <ribbon:RibbonTab Header="Библиотека политик">
                <ribbon:RibbonGroup Header="Политики">
                    <ribbon:RibbonButton Label="Все политики"
                                  Command="{Binding ShowAllPoliciesCommand}"/>
                    <ribbon:RibbonButton Label="Шаблоны"
                                  Command="{Binding ShowPolicyTemplatesCommand}"/>
                    <ribbon:RibbonButton Label="Архив"
                                  Command="{Binding ShowArchivedPoliciesCommand}"/>
                </ribbon:RibbonGroup>

                <ribbon:RibbonGroup Header="Управление">
                    <ribbon:RibbonButton Label="Создать"
                                  Command="{Binding CreatePolicyCommand}"/>
                    <ribbon:RibbonButton Label="Редактировать"
                                  Command="{Binding EditPolicyCommand}"
                                  IsEnabled="{Binding HasSelectedPolicy}"/>
                    <ribbon:RibbonButton Label="Клонировать"
                                  Command="{Binding ClonePolicyCommand}"
                                  IsEnabled="{Binding HasSelectedPolicy}"/>
                    <ribbon:RibbonButton Label="Удалить"
                                  Command="{Binding DeletePolicyCommand}"
                                  IsEnabled="{Binding HasSelectedPolicy}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

            <!-- WINDOWS POLICIES  -->
            <ribbon:RibbonTab Header="Политики Windows">
                <ribbon:RibbonGroup Header="Безопасность">
                    <ribbon:RibbonButton Label="Пароли"
                                  Command="{Binding OpenPasswordPolicyCommand}"/>
                    <ribbon:RibbonButton Label="BitLocker"
                                  Command="{Binding OpenBitLockerPolicyCommand}"/>
                    <ribbon:RibbonButton Label="Firewall"
                                  Command="{Binding OpenFirewallPolicyCommand}"/>
                </ribbon:RibbonGroup>

                <ribbon:RibbonGroup Header="Система">
                    <ribbon:RibbonButton Label="Службы"
                                  Command="{Binding OpenServicesPolicyCommand}"/>
                    <ribbon:RibbonButton Label="Реестр"
                                  Command="{Binding OpenRegistryPolicyCommand}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

            <!-- DEVICE POLICIES -->
            <ribbon:RibbonTab Header="Политики по устройствам">
                <ribbon:RibbonGroup Header="Назначения">
                    <ribbon:RibbonButton Label="Назначенные политики"
                                  Command="{Binding ShowAssignedPoliciesCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                    <ribbon:RibbonButton Label="История"
                                  Command="{Binding ShowPolicyHistoryCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                </ribbon:RibbonGroup>

                <ribbon:RibbonGroup Header="Действия">
                    <ribbon:RibbonButton Label="Применить повторно"
                                  Command="{Binding ReapplyPoliciesCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                    <ribbon:RibbonButton Label="Откатить"
                                  Command="{Binding RollbackPoliciesCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                    <ribbon:RibbonButton Label="Синхронизировать"
                                  Command="{Binding SyncPoliciesCommand}"
                                  IsEnabled="{Binding HasSelectedAgent}"/>
                </ribbon:RibbonGroup>
            </ribbon:RibbonTab>

        </ribbon:Ribbon>


        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Master: List of Agents с контекстным меню -->
            <ListBox Grid.Column="0" ItemsSource="{Binding Agents}" SelectedItem="{Binding SelectedAgent, Mode=TwoWay}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="4">
                            <TextBlock Text="{Binding HostName}" FontWeight="Bold" FontSize="14"/>
                            <TextBlock Text="{Binding IpAddress}" FontSize="12"/>
                            <TextBlock Text="{Binding LastHeartbeat, StringFormat='Last heartbeat: {0:G}'}" FontSize="12"/>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>

                <!-- Context Menu для агента -->
                <ListBox.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Примененные политики"
                      Click="AgentContext_ShowAppliedPolicies"/>
                        <MenuItem Header="Применить политику"
                      Click="AgentContext_ApplyPolicy"/>
                    </ContextMenu>
                </ListBox.ContextMenu>
            </ListBox>

            <!-- Detail: Agent Info с ScrollViewer -->
            <ScrollViewer Grid.Column="1" Margin="8" VerticalScrollBarVisibility="Auto">
                <TabControl DataContext="{Binding SelectedAgentDetail}">
                    <TabItem Header="Overview">
                        <StackPanel Margin="8">
                            <TextBlock Text="{Binding AgentId}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding HostName}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding IpAddress}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding IsOnline}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding LastHeartbeat}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding Manufacturer}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding Model}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding FirmwareVersion}" FontSize="14" Margin="0,0,0,4"/>
                        </StackPanel>
                    </TabItem>

                    <TabItem Header="System Info">
                        <StackPanel Margin="8">
                            <TextBlock Text="{Binding Cpu}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding RamGb, StringFormat='RAM: {0} GB'}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding OsVersion}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding HostnameFull}" FontSize="14" Margin="0,0,0,4"/>
                            <TextBlock Text="Disks:" FontWeight="Bold" Margin="0,4,0,2"/>
                            <ItemsControl ItemsSource="{Binding Disks}" Margin="0,0,0,4"/>
                            <TextBlock Text="GPU:" FontWeight="Bold" Margin="0,4,0,2"/>
                            <ItemsControl ItemsSource="{Binding Gpus}" Margin="0,0,0,4"/>
                            <TextBlock Text="IP Addresses:" FontWeight="Bold" Margin="0,4,0,2"/>
                            <ItemsControl ItemsSource="{Binding IpAddresses}" Margin="0,0,0,4"/>
                            <TextBlock Text="MAC Addresses:" FontWeight="Bold" Margin="0,4,0,2"/>
                            <ItemsControl ItemsSource="{Binding MacAddresses}" Margin="0,0,0,4"/>
                            <TextBlock Text="{Binding Motherboard}" FontSize="14" Margin="0,0,0,4"/>
                        </StackPanel>
                    </TabItem>
                    <TabItem Header="Users">
                        <Grid Margin="8">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBlock
                                Text="{Binding Users.Error}"
                                Foreground="Red"/>

                            <!-- Users list с контекстным меню -->
                            <DataGrid
                                Grid.Row="1"
                                ItemsSource="{Binding Users.Users}"
                                AutoGenerateColumns="False"
                                IsReadOnly="True"
                                RowHeaderWidth="0">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}"/>
                                    <DataGridTextColumn Header="SID" Binding="{Binding Sid}"/>
                                    <DataGridTextColumn Header="Type" Binding="{Binding AccountType}"/>
                                    <DataGridTextColumn Header="Last Logon" Binding="{Binding LastLogon, StringFormat={}{0:G}}"/>
                                    <DataGridTextColumn Header="Groups" Binding="{Binding Groups}"/>
                                </DataGrid.Columns>

                                <!-- Context Menu для пользователя -->
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow">
                                        <Setter Property="ContextMenu">
                                            <Setter.Value>
                                                <ContextMenu
                                                    DataContext="{Binding PlacementTarget.DataContext,
                                                    RelativeSource={RelativeSource Self}}">

                                                    <MenuItem Header="Примененные политики"
                                                        Command="{Binding ApplyPolicyCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"/>

                                                    <MenuItem Header="Применить политику"
                                                        Command="{Binding ApplyPolicyCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"/>
                                                </ContextMenu>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </DataGrid.RowStyle>

                            </DataGrid>
                        </Grid>
                    </TabItem>
                </TabControl>
            </ScrollViewer>
        </Grid>
    </Grid>
</Window>
